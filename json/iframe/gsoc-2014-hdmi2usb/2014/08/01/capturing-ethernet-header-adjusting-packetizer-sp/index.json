{"title":"Capturing Ethernet header, adjusting packetizer speed and moving between OS","created_at":"2014-08-01 04:40:00 UTC","author":"Tariq (Ethernet Support)","content":"&nbsp;I was asked about what is the inter-packet gap (IPG) and can this be varied. I checked and it turns out that IPG is inserted by PHY and not MAC. So MAC has no control over it. Since we are using Marvell 88E1111 PHY, the PHY inserts preamble, start of frame delimiter, CRC and inter-packet gap. The following wikipedia post is really useful<br /><br /><a href=\"http://en.wikipedia.org/wiki/Ethernet_frame\">http://en.wikipedia.org/wiki/Ethernet_frame</a><br /><br />Then &nbsp;i was after capturing Ethernet Header (&nbsp;preamble, start of frame delimiter, CRC and inter-packet gap) but this is not possible given the hardware (NIC + Ubuntu) that i have.<br /><br />This stackexchnage &nbsp;post is useful.<br /><br /><a href=\"http://serverfault.com/questions/521443/can-wireshark-capture-an-entire-ethernet-frame-including-preamble-crc-and-inter\">http://serverfault.com/questions/521443/can-wireshark-capture-an-entire-ethernet-frame-including-preamble-crc-and-inter</a><br /><br />I came across the following raw Ethernet Capture tool.<br /><br /><a href=\"https://gist.github.com/austinmarton/2862515\">https://gist.github.com/austinmarton/2862515</a><br /><br />I Compiled its C source code to capture raw packets but for some reason, NIC + Ubuntu are stripping this information (preamble, start of frame delimiter, crc and ipg) and packets start from MAC header &nbsp;(dst mac address, src MAC address ...)<br /><br /><a href=\"http://pastebin.com/gMPnzy0g\">http://pastebin.com/gMPnzy0g</a><br /><br />Then i did calculation based on the transmitter packetizer to see how fast its throughput is. It turns out that it is actually 3x faster than 1 Gbps. As mentioned earlier, either the transmitter should slow down or the receiver should catch up. I am sticking to the first approach of slowing down the transmitter. Below is how and by how much?<br /><br />I calculated the time to send one packet given 30 fps and then found out the delay to insert between packets (3000 clock cycles, where one cycle = 1/125 Mhz). I shall post these calculations tomorrow.<br /><br /><br />After configuring 3000 cycles delay between packets, i sent 102 packets (0 to 101 ) (see the last to last blog) from FPGA to PC (Ubuntu 13.10 machine). It turned out that Gstreamer got stuck at packet # 97 and never got to receive packet 98 till 101. Wireshark behaved differently from Gstreamer. It showed a couple of missing packets but those packets were successfully captured by Gstreamer AND Wireshark showed couple of packets that Gstreamer could not capture (e.g., packet # 98, 99, 100 and 101).<br /><br />&nbsp;It seemed that the transmitter needed to slow down further.So i increased the inter-packet delay &nbsp;to 5000 clock cycles but still Gstreamer would get stuck at packet # 97. I knew that if i increase the delay to 20,000 clock cycles, it would work but that is not ideal as it would mean &lt; 10 fps.<br /><br />So i moved to my laptop that has 1 Gbps NIC but different Operating System (Windows 7) and used a newe Cat 6 cable. I configured the FPGA to send 102 packets to the laptop where the inter-packet delay is configured to be 3000 clock cycles. I was running Wireshark in Windows 7. It turned out that ALL the packets got captured and Wireshark did n't drop even a single packet. &nbsp;I could not get Gstreamer to work on Windows 7 for some reason. Gstreamer runs but does not produce any output.<br /><br />Here is the successful 102 packets captured by Wireshark in Windows 7 with inter-packet delay of 3000 clock cycles.<br /><br /><a href=\"http://pastebin.com/Rw7FXKQd\">http://pastebin.com/Rw7FXKQd</a><br /><br />You may want to look at the&nbsp;<a href=\"http://hdmi2ethernet.blogspot.com/2014/07/testing-rtp-packetizer-with-multiple-2.html\">older blog post</a>&nbsp;to decipher the above packets.<br /><div><br /></div><br />The point is that successful capture depends upon the NIC, cable and OS. I shall see if can get a recent NIC to reproduce the same behavior with Ubuntu 13.10 machine. Ethtool provides the following information about NIC<br /><br /><a href=\"http://pastebin.com/VRLUJwLL\">http://pastebin.com/VRLUJwLL</a><br /><br />The fact that there is no mention of GMII is intriguing. What do you think?<br /><br /><br />I am on un-official vacation from tomorrow till next Friday. I shall work on this as i get time. The blogs might not be updated regularly. The remaining goal is further testing and documentation.<br /><br /><br /><br /><br /><div class=\"author\">\n  <span>\n    <i>Originally posted on <a href=\"http://hdmi2ethernet.blogspot.com/\">GSOC 2014</a></i>\n  </span>\n</div>\n"}